<!DOCTYPE html>
<html>

<head>
    <script src="d3.v7.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="require.js"></script>

    <script src="../src/Visualization.js"></script>
    <script src="../src/BarChart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let layout = document.querySelector("#chart");

            let config = {
                drawStrategy: "scale break perspective"
            };

            let break_inicial = 11000;
            let breakfinal = 76000;

            let barchart = new BarChart(layout, config, break_inicial, breakfinal);

            this.base4 = [
                { valor: 2086.788469112473 },
                { valor: 77412.47462722816 },
                { valor: 798.87765686746255 },
                { valor: 85685.42065542887 },
                { valor: 875.6592439886408 },
                { valor: 680.341495589178564 },
                { valor: 555.6272574356251 },
                { valor: 9878.030571097508 },
                { valor: 420.07647618035685 },
                { valor: 10858.416405323893 },
                { valor: 634.4914334661673 },
                { valor: 302.267786914083707 },
                { valor: 396.77761749210134 },
                { valor: 7398.659925373594 },
                { valor: 5661.633142901761 }
            ];
            barchart.data(base4);
            barchart.redraw();

        });

    </script>
    <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
    <header class="bg-slate-200 p-2 ">
        <img class="h-24" src="./Imagem/logo_labvis.svg" alt="">
    </header>

    <main>
        <h1 class="p-4">Optimized bar chart</h1>
        <p class="p-4">Mitigating outlier problems</p>

        <div id="chart" style="height: 600px; width: 90%;"></div>

        <button onclick="downloadSVG()" class="m-4 px-4 py-2 bg-blue-500 text-white rounded">Download SVG</button>
        <button onclick="downloadPNG()" class="m-4 px-4 py-2 bg-green-600 text-white rounded">Download PNG</button>

    </main>

    <script>
    function downloadSVG() {
        const chartDiv = document.getElementById("chart");
        const svg = chartDiv.querySelector("svg");

        if (!svg) {
            alert("SVG não encontrado.");
            return;
        }

        // Clona o SVG e define atributos necessários
        const clonedSvg = svg.cloneNode(true);
        clonedSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");

        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clonedSvg);
        const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.href = url;
        link.download = "grafico.svg";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function downloadPNG() {
        const chartDiv = document.getElementById("chart");
        const svg = chartDiv.querySelector("svg");

        if (!svg) {
            alert("SVG não encontrado.");
            return;
        }

        const clonedSvg = svg.cloneNode(true);
        clonedSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");

        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clonedSvg);
        const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
        const url = URL.createObjectURL(svgBlob);

        const image = new Image();
        image.onload = function () {
            const canvas = document.createElement("canvas");
            canvas.width = svg.viewBox.baseVal.width || svg.clientWidth;
            canvas.height = svg.viewBox.baseVal.height || svg.clientHeight;

            const context = canvas.getContext("2d");
            context.fillStyle = "white"; // fundo branco
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, 0, 0);

            URL.revokeObjectURL(url);
            canvas.toBlob(function (blob) {
                const link = document.createElement("a");
                link.download = "grafico.png";
                link.href = URL.createObjectURL(blob);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, "image/png");
        };

        image.onerror = function () {
            alert("Erro ao converter SVG para imagem.");
        };

        image.src = url;
    }
    </script>

</body>

</html>